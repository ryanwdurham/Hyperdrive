<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPER DRIVE: NEON HIGHWAY</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Audiowide&family=Orbitron:wght@400;700;900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; }
        
        #controls { position: absolute; top: 75px; left: 12px; display: flex; gap: 8px; z-index: 150; }
        .control-btn { width: 40px; height: 40px; background: rgba(0,20,40,0.9); border: 2px solid #0ff; border-radius: 6px; color: #0ff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; box-shadow: 0 0 12px rgba(0,255,255,0.3); }
        .control-btn:hover { background: rgba(0,255,255,0.2); transform: scale(1.05); }
        .control-btn.active { background: rgba(255,0,85,0.3); border-color: #f05; color: #f05; }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 100; }
        #scorePanel { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 10px 12px; background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%); }
        .stat-group { text-align: left; }
        .stat-group.right { text-align: right; }
        .stat-label { font-size: 7px; letter-spacing: 1.5px; color: #0ff; text-shadow: 0 0 8px #0ff; opacity: 0.8; margin-bottom: 2px; }
        .stat-value { font-size: 20px; font-weight: 900; color: #fff; text-shadow: 0 0 12px #0ff; font-family: 'Audiowide', cursive; }
        #weaponPower { font-size: 14px; color: #ff0; text-shadow: 0 0 10px #ff0; }
        
        #mobileControls { position: absolute; bottom: 0; left: 0; width: 100%; height: 150px; display: none; z-index: 101; background: linear-gradient(0deg, rgba(0,0,0,0.7), transparent); }
        #mobileControls.active { display: flex; }
        .control-area { flex: 1; display: flex; align-items: center; justify-content: center; }
        .btn-move { width: 80px; height: 80px; border-radius: 50%; background: radial-gradient(circle, rgba(0,255,255,0.4), rgba(0,255,255,0.1)); border: 3px solid #0ff; box-shadow: 0 0 20px #0ff; font-size: 32px; color: #0ff; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        .btn-move:active { transform: scale(0.9); }
        
        #message { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; font-weight: 900; color: #fff; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 102; text-align: center; font-family: 'Audiowide', cursive; white-space: pre-line; }
        #message.show { opacity: 1; }
        
        #startScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0a0a1e 0%, #1a0a2e 50%, #0a0a1e 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; }
        #startScreen.hidden { display: none; }
        .game-title { font-family: 'Audiowide', cursive; font-size: 68px; background: linear-gradient(45deg, #0ff, #f0f, #ff0, #0ff); background-size: 200% 200%; -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; animation: gradientShift 3s ease infinite; text-align: center; }
        .game-subtitle { font-size: 26px; color: #f0f; text-shadow: 0 0 15px #f0f; margin-bottom: 30px; letter-spacing: 10px; text-align: center; }
        
        .difficulty-selector { margin-bottom: 40px; display: flex; gap: 20px; }
        .diff-btn { padding: 18px 50px; font-size: 24px; font-family: 'Audiowide', cursive; background: rgba(0,40,80,0.6); border: 3px solid #0ff; color: #0ff; cursor: pointer; border-radius: 10px; transition: 0.3s; text-shadow: 0 0 10px #0ff; }
        .diff-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px #0ff; }
        .diff-btn.selected { background: linear-gradient(135deg, #0ff, #0af); color: #000; border-color: #fff; box-shadow: 0 0 40px #0ff; }
        .diff-btn.hard { border-color: #f05; color: #f05; text-shadow: 0 0 10px #f05; }
        .diff-btn.hard.selected { background: linear-gradient(135deg, #f05, #f0f); color: #fff; border-color: #fff; box-shadow: 0 0 40px #f05; }
        
        .start-btn { padding: 20px 65px; font-size: 30px; font-family: 'Audiowide', cursive; background: linear-gradient(135deg, #f05, #f0f, #05f); background-size: 200%; border: none; color: #fff; cursor: pointer; box-shadow: 0 0 40px #f0f; border-radius: 12px; transition: 0.3s; animation: gradientShift 3s ease infinite; }
        .start-btn:hover { transform: scale(1.08); }
        
        #gameOverScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 201; }
        #gameOverScreen.show { display: flex; }
        .game-over-title { font-family: 'Audiowide', cursive; font-size: 50px; color: #f05; text-shadow: 0 0 30px #f05; margin-bottom: 25px; }
        .final-stats { background: rgba(0,20,40,0.8); border: 3px solid #0ff; border-radius: 15px; padding: 25px 45px; margin-bottom: 25px; box-shadow: 0 0 30px rgba(0,255,255,0.5); }
        .final-stat { display: flex; justify-content: space-between; gap: 40px; margin: 12px 0; font-size: 22px; color: #0ff; }
        .final-stat-value { color: #fff; font-family: 'Audiowide', cursive; }
        .high-scores { background: rgba(20,0,40,0.8); border: 3px solid #f0f; border-radius: 15px; padding: 20px 35px; margin-bottom: 25px; max-width: 450px; }
        .high-scores-title { font-family: 'Audiowide', cursive; font-size: 26px; color: #f0f; text-shadow: 0 0 15px #f0f; margin-bottom: 15px; text-align: center; }
        .high-score-entry { display: flex; justify-content: space-between; padding: 6px 12px; margin: 4px 0; background: rgba(0,0,0,0.4); border-radius: 5px; font-size: 16px; }
        .high-score-entry.current { background: rgba(255,215,0,0.2); border: 2px solid #ffd700; }
        .high-score-rank { color: #ff0; font-weight: bold; }
        .high-score-score { color: #0ff; font-family: 'Audiowide', cursive; }
        
        @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        
        @media (max-width: 768px) {
            .game-title { font-size: 46px; }
            .game-subtitle { font-size: 18px; letter-spacing: 6px; }
            .diff-btn { font-size: 18px; padding: 14px 35px; }
            .difficulty-selector { gap: 12px; }
            .start-btn { font-size: 24px; padding: 16px 45px; }
            .stat-value { font-size: 17px; }
            #scorePanel { grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 8px; }
            #controls { top: 60px; }
            .game-over-title { font-size: 38px; }
            .final-stat { font-size: 18px; }
        }
    </style>
</head>
<body>
<canvas id="game"></canvas>
<div id="controls">
    <div class="control-btn" id="pauseBtn">‚è∏</div>
    <div class="control-btn" id="muteBtn">üîä</div>
</div>
<div id="hud">
    <div id="scorePanel">
        <div class="stat-group"><div class="stat-label">SCORE</div><div class="stat-value" id="score">000000</div></div>
        <div class="stat-group"><div class="stat-label">COINS</div><div class="stat-value" id="coins">0</div></div>
        <div class="stat-group"><div class="stat-label">TIME</div><div class="stat-value" id="time">0:00</div></div>
        <div class="stat-group right"><div class="stat-label">HEALTH</div><div class="stat-value" id="health">100%</div></div>
        <div class="stat-group right"><div class="stat-label">WEAPON</div><div class="stat-value" id="weaponType">BLASTER</div><div id="weaponPower"></div></div>
    </div>
</div>
<div id="mobileControls">
    <div class="control-area"><div class="btn-move" id="btnLeft">‚óÑ</div></div>
    <div class="control-area"><div class="btn-move" id="btnRight">‚ñ∫</div></div>
</div>
<div id="message"></div>
<div id="startScreen">
    <div class="game-title">HYPER DRIVE</div>
    <div class="game-subtitle">NEON HIGHWAY</div>
    <div class="difficulty-selector">
        <div class="diff-btn selected" id="easyBtn">EASY</div>
        <div class="diff-btn hard" id="hardBtn">HARD</div>
    </div>
    <button class="start-btn" id="startBtn">BEGIN MISSION</button>
</div>
<div id="gameOverScreen">
    <div class="game-over-title">MISSION COMPLETE</div>
    <div class="final-stats">
        <div class="final-stat"><span>Final Score:</span><span class="final-stat-value" id="finalScore">0</span></div>
        <div class="final-stat"><span>Coins:</span><span class="final-stat-value" id="finalCoins">0</span></div>
        <div class="final-stat"><span>Coin Bonus:</span><span class="final-stat-value" id="coinBonus">0</span></div>
        <div class="final-stat"><span>Time:</span><span class="final-stat-value" id="finalTime">0:00</span></div>
        <div class="final-stat"><span>Difficulty:</span><span class="final-stat-value" id="finalDiff">EASY</span></div>
    </div>
    <div class="high-scores">
        <div class="high-scores-title">TOP 10 HIGH SCORES</div>
        <div id="highScoresList"></div>
    </div>
    <button class="start-btn" id="playAgainBtn">PLAY AGAIN</button>
</div>
<script>
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');
const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<768;
let soundEnabled=true,SOUNDS={},currentMusicTrack=0,selectedDifficulty='easy';

function initSounds(){
    const tracks=['music1','music2','music3','music4'];
    tracks.forEach(t=>{try{const s=new Audio(`sounds/${t}.mp3`);s.volume=0.3;s.loop=false;SOUNDS[t]=s}catch(e){}});
    const explosions=['explosion','explosion2'];
    explosions.forEach(e=>{try{const s=new Audio(`sounds/${e}.mp3`);s.volume=0.4;SOUNDS[e]=s}catch(er){}});
    try{SOUNDS.shoot=new Audio('sounds/laser.mp3');SOUNDS.shoot.volume=0.05}catch(e){}
    try{SOUNDS.powerup=new Audio('sounds/powerup.mp3');SOUNDS.powerup.volume=0.5}catch(e){}
    try{SOUNDS.hit=new Audio('sounds/hit.mp3');SOUNDS.hit.volume=0.4}catch(e){}
    try{SOUNDS.coin=new Audio('sounds/coin.mp3');SOUNDS.coin.volume=0.4}catch(e){}
}

function playSound(n){
    if(!soundEnabled)return;
    if(n.startsWith('explosion')){
        const ex=Math.random()<0.5?'explosion':'explosion2';
        if(SOUNDS[ex]){try{const s=SOUNDS[ex].cloneNode();s.volume=0.4;s.play().catch(e=>{})}catch(e){}}
    }else if(SOUNDS[n]){try{const s=SOUNDS[n].cloneNode();s.volume=SOUNDS[n].volume;s.play().catch(e=>{})}catch(e){}}
}

function playNextMusic(){
    const tracks=['music1','music2','music3','music4'];
    if(soundEnabled){
        currentMusicTrack=(currentMusicTrack+1)%tracks.length;
        const track=tracks[currentMusicTrack];
        if(SOUNDS[track]){
            SOUNDS[track].currentTime=0;
            SOUNDS[track].play().catch(e=>{});
            SOUNDS[track].onended=()=>{if(GS.run&&!GS.pause)playNextMusic()}
        }
    }
}

function stopAllMusic(){
    ['music1','music2','music3','music4'].forEach(t=>{if(SOUNDS[t])SOUNDS[t].pause()});
}

function getHighScores(diff){try{const s=localStorage.getItem(`hyperDriveHS_${diff}`);return s?JSON.parse(s):[]}catch(e){return[]}}
function saveHighScore(sc,co,ti,diff){try{const hs=getHighScores(diff),ns={score:sc,coins:co,time:ti,date:new Date().toLocaleDateString()};hs.push(ns);hs.sort((a,b)=>b.score-a.score);hs.splice(10);localStorage.setItem(`hyperDriveHS_${diff}`,JSON.stringify(hs));return hs.findIndex(s=>s===ns)}catch(e){return-1}}
function displayHighScores(cs,diff){const hs=getHighScores(diff),lst=document.getElementById('highScoresList');lst.innerHTML='';hs.forEach((s,i)=>{const e=document.createElement('div');e.className='high-score-entry';if(s.score===cs)e.classList.add('current');e.innerHTML=`<span class="high-score-rank">#${i+1}</span><span class="high-score-score">${s.score.toLocaleString()}</span>`;lst.appendChild(e)});for(let i=hs.length;i<10;i++){const e=document.createElement('div');e.className='high-score-entry';e.innerHTML=`<span class="high-score-rank">#${i+1}</span><span class="high-score-score">---</span>`;lst.appendChild(e)}}

const DIFF_CONFIGS={
    easy:{
        name:"EASY",
        TIERS:[
            {t:0,spd:3.5,eRate:90,cRate:25,oRate:155,tRate:245,shoot:0.008,hpMult:1.0},
            {t:30,spd:4.8,eRate:70,cRate:28,oRate:130,tRate:205,shoot:0.012,hpMult:1.0},
            {t:60,spd:6.2,eRate:54,cRate:32,oRate:105,tRate:165,shoot:0.015,hpMult:1.0},
            {t:90,spd:7.5,eRate:42,cRate:36,oRate:85,tRate:135,shoot:0.018,hpMult:1.1},
            {t:120,spd:8.8,eRate:33,cRate:40,oRate:70,tRate:110,shoot:0.021,hpMult:1.2},
            {t:150,spd:10.2,eRate:27,cRate:46,oRate:58,tRate:90,shoot:0.024,hpMult:1.3},
            {t:180,spd:11.5,eRate:22,cRate:52,oRate:48,tRate:75,shoot:0.027,hpMult:1.5}
        ]
    },
    hard:{
        name:"HARD",
        TIERS:[
            {t:0,spd:4.5,eRate:75,cRate:22,oRate:140,tRate:220,shoot:0.012,hpMult:1.2},
            {t:30,spd:6.5,eRate:58,cRate:26,oRate:115,tRate:180,shoot:0.017,hpMult:1.4},
            {t:60,spd:8.5,eRate:45,cRate:30,oRate:92,tRate:145,shoot:0.022,hpMult:1.6},
            {t:90,spd:11,eRate:35,cRate:34,oRate:72,tRate:115,shoot:0.028,hpMult:1.9},
            {t:120,spd:13.5,eRate:28,cRate:38,oRate:58,tRate:92,shoot:0.034,hpMult:2.2},
            {t:150,spd:16,eRate:23,cRate:44,oRate:46,tRate:72,shoot:0.040,hpMult:2.6},
            {t:180,spd:19,eRate:19,cRate:50,oRate:38,tRate:58,shoot:0.046,hpMult:3.0},
            {t:240,spd:22,eRate:16,cRate:58,oRate:32,tRate:48,shoot:0.052,hpMult:3.5},
            {t:300,spd:25,eRate:13,cRate:65,oRate:28,tRate:40,shoot:0.058,hpMult:4.0}
        ]
    }
};

const CFG={PLAYER_SPEED:isMobile?11:15,PLAYER_W:45,PLAYER_H:70,MAX_HEALTH:100,ROAD_W:isMobile?0.95:0.75,LANES:5,THEMES:[{n:"MIDNIGHT",c:['#0a0a2e','#16213e','#1a1a3e'],a:'#0ff'},{n:"SUNSET",c:['#2e0a2e','#3e1626','#2e0a1a'],a:'#f0f'},{n:"CYBER",c:['#0a2e1a','#16263e','#0a1a2e'],a:'#0f0'},{n:"BLADE",c:['#2e2e0a','#3e3616','#2e1a0a'],a:'#ff0'},{n:"RETRO",c:['#2e0a1a','#1a0a2e','#0a1a2e'],a:'#f05'}],WPNS:[{n:"BLASTER",c:"#0ff",r:120,d:1,p:"single"},{n:"TRIPLE",c:"#0f0",r:100,d:1,p:"triple"},{n:"SPREAD",c:"#f0f",r:80,d:1,p:"spread"},{n:"LASER",c:"#f00",r:60,d:2,p:"laser"},{n:"PLASMA",c:"#ff0",r:50,d:1.5,p:"plasma"}],BSPD:18,EBSPD:6,ETYPES:[{n:"SCOUT_R",sz:30,hp:1,spd:1.1,pts:80,c:'#f05',sh:'arrow'},{n:"SCOUT_O",sz:32,hp:1,spd:1.15,pts:85,c:'#f40',sh:'arrow'},{n:"SCOUT_Y",sz:28,hp:1,spd:1.2,pts:90,c:'#fa0',sh:'arrow'},{n:"FIGHTER_B",sz:42,hp:2,spd:0.95,pts:180,c:'#08f',sh:'fighter'},{n:"FIGHTER_P",sz:44,hp:2,spd:0.92,pts:190,c:'#80f',sh:'fighter'},{n:"FIGHTER_C",sz:40,hp:2,spd:0.98,pts:170,c:'#0fa',sh:'fighter'},{n:"ASSAULT_G",sz:48,hp:3,spd:0.88,pts:280,c:'#0f4',sh:'assault'},{n:"ASSAULT_P",sz:50,hp:3,spd:0.85,pts:300,c:'#f08',sh:'assault'},{n:"TANK",sz:60,hp:5,spd:0.7,pts:450,c:'#f0f',sh:'tank'},{n:"HEAVY",sz:65,hp:6,spd:0.65,pts:500,c:'#c0f',sh:'tank'},{n:"CRUISER",sz:75,hp:8,spd:0.55,pts:700,c:'#90f',sh:'cruiser'},{n:"BOSS",sz:95,hp:12,spd:0.45,pts:1200,c:'#0ff',sh:'boss'}],PINT:340,COINV:10,COINB:5,DELAY:5};

let GS={run:false,pause:false,frm:0,st:0,et:0,sc:0,coin:0,hp:CFG.MAX_HEALTH,wi:0,wpwr:0,tier:0,theme:0,spd:3.5,freq:0.008,hpMult:1.0,px:0,py:0,tx:0,shake:0,shld:false,shldT:0,dbl:false,dblT:0,fire:true,lft:0,mvL:false,mvR:false,diff:'easy'};
let bul=[],ebul=[],enm=[],obs=[],coin=[],pwr=[],part=[],trap=[];

const rnd=(a,b)=>Math.random()*(b-a)+a,rndI=(a,b)=>Math.floor(rnd(a,b+1)),colC=(x1,y1,r1,x2,y2,r2)=>{const dx=x1-x2,dy=y1-y2;return(dx*dx+dy*dy)<(r1+r2)*(r1+r2)},colR=(x1,y1,w1,h1,x2,y2,w2,h2)=>x1<x2+w2&&x1+w1>x2&&y1<y2+h2&&y1+h1>y2,getRd=()=>{const w=canvas.width*CFG.ROAD_W,l=(canvas.width-w)/2;return{l,r:l+w,w}},getLn=ln=>{const r=getRd(),lw=r.w/CFG.LANES;return r.l+lw*ln+lw/2},exp=(x,y,c,n=20)=>{for(let i=0;i<n;i++){const a=(Math.PI*2/n)*i+rnd(-0.2,0.2),s=rnd(2,10);part.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,c,life:1,decay:rnd(0.018,0.025),sz:rnd(3,8)})}},msg=(t,c)=>{const m=document.getElementById('message');m.textContent=t;m.style.color=c;m.style.textShadow=`0 0 25px ${c}`;m.classList.add('show');setTimeout(()=>m.classList.remove('show'),1800)};

class Bullet{constructor(x,y,vx=0,vy=-CFG.BSPD,wi=0,pwr=0){this.x=x;this.y=y;this.vx=vx;this.vy=vy;this.w=CFG.WPNS[wi];this.pwr=pwr;this.trail=[];this.dead=false}update(){this.trail.push({x:this.x,y:this.y});if(this.trail.length>5)this.trail.shift();this.x+=this.vx;this.y+=this.vy;if(this.y<-60||this.x<-50||this.x>canvas.width+50)this.dead=true}draw(){ctx.save();if(this.trail.length>1){ctx.globalAlpha=0.3;this.trail.forEach((t,i)=>{ctx.globalAlpha=(i/this.trail.length)*0.4;ctx.fillStyle=this.w.c;ctx.fillRect(t.x-2,t.y,4,20)});ctx.globalAlpha=1}ctx.shadowBlur=20+this.pwr*5;ctx.shadowColor=this.w.c;ctx.fillStyle=this.w.c;if(this.w.p==='plasma'){const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,8+this.pwr);g.addColorStop(0,this.w.c);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.arc(this.x,this.y,8+this.pwr,0,Math.PI*2);ctx.fill()}else{ctx.fillRect(this.x-2-this.pwr,this.y,4+this.pwr*2,20+this.pwr*2)}ctx.globalAlpha=0.6;ctx.fillRect(this.x-3-this.pwr,this.y+20,6+this.pwr*2,8);ctx.restore()}}

class EBullet{constructor(x,y,tx,ty){this.x=x;this.y=y;const a=Math.atan2(ty-y,tx-x);this.vx=Math.cos(a)*CFG.EBSPD;this.vy=Math.sin(a)*CFG.EBSPD;this.sz=5;this.dead=false}update(){this.x+=this.vx;this.y+=this.vy;if(this.y>canvas.height+50||this.y<-50||this.x<-50||this.x>canvas.width+50)this.dead=true}draw(){ctx.save();ctx.shadowBlur=12;ctx.shadowColor='#f05';ctx.fillStyle='#f05';ctx.beginPath();ctx.arc(this.x,this.y,this.sz,0,Math.PI*2);ctx.fill();ctx.globalAlpha=0.4;ctx.beginPath();ctx.arc(this.x,this.y,this.sz+3,0,Math.PI*2);ctx.fill();ctx.restore()}}

class Enemy{constructor(x,y,ti=0){this.x=x;this.y=y;this.t=CFG.ETYPES[Math.min(ti,CFG.ETYPES.length-1)];this.sz=this.t.sz;this.basehp=this.t.hp;this.mhp=Math.ceil(this.basehp*GS.hpMult);this.hp=this.mhp;this.spd=GS.spd*this.t.spd;this.c=this.t.c;this.sh=this.t.sh;this.rot=0;this.rspd=(rnd(-0.5,0.5))*0.04;this.pts=this.t.pts;this.cool=0;this.pls=rnd(0,Math.PI*2);this.frm=0;this.dead=false}update(){this.y+=this.spd;this.rot+=this.rspd;this.pls+=0.08;this.frm++;if(this.basehp>1&&this.cool<=0&&this.y>80&&this.y<canvas.height-200){if(Math.random()<GS.freq){ebul.push(new EBullet(this.x,this.y+this.sz/2,GS.px,GS.py));this.cool=90+rnd(0,90);playSound('shoot')}}this.cool--;if(this.y>canvas.height+100)this.dead=true}draw(){ctx.save();ctx.translate(this.x,this.y);const p=Math.sin(this.pls)*0.08+1;ctx.scale(p,p);ctx.shadowBlur=22;ctx.shadowColor=this.c;if(this.sh==='arrow'){ctx.rotate(this.rot);ctx.fillStyle=this.c;ctx.beginPath();ctx.moveTo(0,-this.sz/2);ctx.lineTo(this.sz/3.5,this.sz/3);ctx.lineTo(this.sz/6,this.sz/2);ctx.lineTo(-this.sz/6,this.sz/2);ctx.lineTo(-this.sz/3.5,this.sz/3);ctx.closePath();ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2.5;ctx.stroke();const cs=5+Math.sin(this.frm*0.15)*2;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,cs,0,Math.PI*2);ctx.fill()}else if(this.sh==='fighter'){ctx.rotate(this.rot*0.3);ctx.fillStyle=this.c;ctx.fillRect(-this.sz/4,-this.sz/2,this.sz/2,this.sz);ctx.beginPath();ctx.moveTo(-this.sz/4,0);ctx.lineTo(-this.sz/2,-this.sz/4);ctx.lineTo(-this.sz/2,this.sz/4);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(this.sz/4,0);ctx.lineTo(this.sz/2,-this.sz/4);ctx.lineTo(this.sz/2,this.sz/4);ctx.closePath();ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=3;ctx.strokeRect(-this.sz/4,-this.sz/2,this.sz/2,this.sz);const cg=Math.sin(this.frm*0.1)*0.2+0.6;ctx.fillStyle=`rgba(255,255,255,${cg})`;ctx.fillRect(-this.sz/6,-this.sz/3,this.sz/3,this.sz/3)}else if(this.sh==='assault'){ctx.rotate(this.rot);ctx.fillStyle=this.c;ctx.fillRect(-this.sz/5,-this.sz/2,this.sz/2.5,this.sz);for(let i=0;i<4;i++){ctx.save();ctx.rotate((Math.PI/2)*i);ctx.translate(0,-this.sz/3);ctx.fillRect(-this.sz/8,0,this.sz/4,this.sz/2.5);ctx.restore()}ctx.strokeStyle='#fff';ctx.lineWidth=2.5;ctx.strokeRect(-this.sz/5,-this.sz/2,this.sz/2.5,this.sz)}else if(this.sh==='tank'){ctx.rotate(this.rot*0.5);ctx.fillStyle=this.c;ctx.beginPath();for(let i=0;i<6;i++){const a=(Math.PI/3)*i,x=Math.cos(a)*this.sz/2,y=Math.sin(a)*this.sz/2;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.closePath();ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=3.5;ctx.stroke();ctx.save();ctx.rotate(this.frm*0.02);ctx.fillStyle='rgba(0,0,0,0.6)';ctx.beginPath();for(let i=0;i<6;i++){const a=(Math.PI/3)*i,x=Math.cos(a)*this.sz/3,y=Math.sin(a)*this.sz/3;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.closePath();ctx.fill();ctx.stroke();ctx.restore();const cg=Math.sin(this.frm*0.15)*0.3+0.7;ctx.fillStyle=`rgba(255,255,255,${cg})`;ctx.beginPath();ctx.arc(0,0,this.sz/5,0,Math.PI*2);ctx.fill()}else if(this.sh==='cruiser'){ctx.rotate(this.rot*0.3);ctx.fillStyle=this.c;ctx.fillRect(-this.sz/3,-this.sz/2,this.sz/1.5,this.sz);ctx.fillRect(-this.sz/2.2,-this.sz/3,this.sz/8,this.sz/1.5);ctx.fillRect(this.sz/3,-this.sz/3,this.sz/8,this.sz/1.5);ctx.strokeStyle='#fff';ctx.lineWidth=4;ctx.strokeRect(-this.sz/3,-this.sz/2,this.sz/1.5,this.sz);const eg=this.frm%4<2;ctx.fillStyle=eg?'#0ff':'#0aa';ctx.fillRect(-this.sz/4,this.sz/2,this.sz/8,10);ctx.fillRect(this.sz/12,this.sz/2,this.sz/8,10)}else{ctx.rotate(this.rot*0.2);ctx.fillStyle=this.c;ctx.beginPath();for(let i=0;i<8;i++){const a=(Math.PI/4)*i,r=i%2===0?this.sz/2:this.sz/2.5,x=Math.cos(a)*r,y=Math.sin(a)*r;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y)}ctx.closePath();ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=4;ctx.stroke();ctx.save();ctx.rotate(-this.frm*0.03);ctx.strokeStyle=this.c;ctx.lineWidth=6;ctx.beginPath();ctx.arc(0,0,this.sz/3,0,Math.PI*2);ctx.stroke();ctx.restore();const g=ctx.createRadialGradient(0,0,0,0,0,this.sz/4);g.addColorStop(0,'#fff');g.addColorStop(0.5,this.c);g.addColorStop(1,'transparent');ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,this.sz/4+Math.sin(this.frm*0.1)*5,0,Math.PI*2);ctx.fill()}ctx.restore()}dmg(d=1){this.hp-=d;if(this.hp<=0){this.dead=true;const p=GS.dbl?this.pts*2:this.pts;GS.sc+=p;exp(this.x,this.y,this.c,30);GS.shake=6+this.mhp*2;playSound('explosion')}else{playSound('hit')}}}

class Coin{constructor(x,y){this.x=x;this.y=y;this.sz=22;this.spd=GS.spd*0.65;this.rot=0;this.frm=0;this.flt=rnd(0,Math.PI*2);this.dead=false}update(){this.y+=this.spd;this.rot+=0.12;this.frm++;if(this.y>canvas.height+100)this.dead=true}draw(){const fy=Math.sin(this.frm*0.1+this.flt)*4,per=Math.cos(this.rot),sx=Math.abs(per);ctx.save();ctx.translate(this.x,this.y+fy);ctx.shadowBlur=30;ctx.shadowColor='#ff0';const g=ctx.createRadialGradient(0,0,0,0,0,this.sz);g.addColorStop(0,'#ffc');g.addColorStop(0.4,'#ff0');g.addColorStop(0.7,'#fd0');g.addColorStop(1,'#c90');ctx.fillStyle=g;ctx.save();ctx.scale(sx,1);ctx.beginPath();ctx.arc(0,0,this.sz,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#fa0';ctx.lineWidth=3;ctx.stroke();if(sx>0.3){ctx.strokeStyle='#c80';ctx.lineWidth=2;ctx.beginPath();ctx.arc(0,0,this.sz*0.7,0,Math.PI*2);ctx.stroke()}ctx.restore();if(sx>0.5){ctx.fillStyle='#850';ctx.font=`bold ${this.sz*1.1}px Arial`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.save();ctx.scale(sx,1);ctx.fillText('$',0,0);ctx.restore()}if(this.frm%20<3){ctx.fillStyle='#fff';ctx.shadowBlur=20;ctx.fillRect(-this.sz/3,0,this.sz/1.5,2);ctx.fillRect(0,-this.sz/3,2,this.sz/1.5)}ctx.restore()}col(){this.dead=true;const v=GS.dbl?CFG.COINV*2:CFG.COINV;GS.coin++;GS.sc+=v;exp(this.x,this.y,'#ff0',12);playSound('coin')}}

class Obs{constructor(x,y){this.x=x;this.y=y;this.w=55+rnd(0,25);this.h=70+rnd(0,35);this.spd=GS.spd;this.c=CFG.ETYPES[rndI(0,5)].c;this.hp=3;this.rot=0;this.rspd=rnd(-0.5,0.5)*0.03;this.frm=0;this.dead=false}update(){this.y+=this.spd;this.rot+=this.rspd;this.frm++;if(this.y>canvas.height+100)this.dead=true}draw(){ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.rot);ctx.shadowBlur=18;ctx.shadowColor=this.c;const p=Math.sin(this.frm*0.08)*0.05+1,w=this.w*p,h=this.h*p;const g=ctx.createLinearGradient(-w/2,-h/2,w/2,h/2);g.addColorStop(0,this.c);g.addColorStop(0.5,'rgba(255,255,255,0.3)');g.addColorStop(1,this.c);ctx.fillStyle=g;ctx.fillRect(-w/2,-h/2,w,h);ctx.strokeStyle='#fff';ctx.lineWidth=3.5;ctx.strokeRect(-w/2,-h/2,w,h);ctx.strokeStyle='rgba(0,0,0,0.6)';ctx.lineWidth=2;const go=(this.frm*2)%20;for(let i=-h/2;i<h/2;i+=20){ctx.beginPath();ctx.moveTo(-w/2,i+go);ctx.lineTo(w/2,i+go);ctx.stroke()}ctx.fillStyle='#ff0';ctx.font='bold 16px Arial';ctx.textAlign='center';ctx.textBaseline='middle';if(this.frm%30<15)ctx.fillText('!',0,0);ctx.restore()}dmg(d=1){this.hp-=d;if(this.hp<=0){this.dead=true;GS.sc+=200;exp(this.x,this.y,this.c,25);GS.shake=12;playSound('explosion')}else{playSound('hit')}}}

class Trap{constructor(ln,tp='spikes'){this.x=getLn(ln);this.y=-100;this.ln=ln;this.tp=tp;this.w=getRd().w/CFG.LANES;this.h=tp==='block'?150:80;this.spd=GS.spd;this.frm=0;this.dmg=tp==='block'?30:20;this.dead=false}update(){this.y+=this.spd;this.frm++;if(this.y>canvas.height+150)this.dead=true}draw(){ctx.save();if(this.tp==='block'){const fl=this.frm%20<10;ctx.fillStyle=fl?'#f00':'#a00';ctx.shadowBlur=fl?40:20;ctx.shadowColor='#f00';const lx=getLn(this.ln),lw=getRd().w/CFG.LANES;ctx.fillRect(lx-lw/2,this.y-this.h/2,lw,this.h);ctx.fillStyle=fl?'#ff0':'#fa0';for(let i=0;i<5;i++){const y=this.y-this.h/2+i*30;ctx.fillRect(lx-lw/2,y,lw,10)}ctx.fillStyle='#fff';ctx.font='bold 20px Arial';ctx.textAlign='center';ctx.shadowBlur=10;ctx.fillText('BLOCKED',lx,this.y)}else{ctx.shadowBlur=20;ctx.shadowColor='#f05';const sc=8,lx=getLn(this.ln),lw=getRd().w/CFG.LANES;for(let i=0;i<sc;i++){const x=lx-lw/2+(lw/sc)*i+lw/(sc*2),sh=25+Math.sin(this.frm*0.1+i)*5;ctx.fillStyle='#f05';ctx.beginPath();ctx.moveTo(x,this.y);ctx.lineTo(x-8,this.y+sh);ctx.lineTo(x+8,this.y+sh);ctx.closePath();ctx.fill();ctx.strokeStyle='#f08';ctx.lineWidth=2;ctx.stroke()}ctx.fillStyle='#602';ctx.fillRect(lx-lw/2,this.y+25,lw,15)}ctx.restore()}}

class Pwr{constructor(x,y,tp){this.x=x;this.y=y;this.tp=tp;this.sz=34;this.spd=GS.spd*0.5;this.pls=0;this.rot=0;this.dead=false}update(){this.y+=this.spd;this.pls+=0.18;this.rot+=0.06;if(this.y>canvas.height+100)this.dead=true}draw(){const sz=this.sz+Math.sin(this.pls)*7;let c='#fff',s='';if(this.tp==='weapon'){c='#f0f';s='‚ö°'}else if(this.tp==='power'){c='#ff6600';s='‚¨Ü'}else if(this.tp==='health'){c='#0f0';s='+'}else if(this.tp==='shield'){c='#0ff';s='‚óÜ'}else if(this.tp==='double'){c='#ff0';s='x2'}else{c='#f05';s='üí£'}ctx.save();ctx.translate(this.x,this.y);ctx.rotate(this.rot);ctx.shadowBlur=35;ctx.shadowColor=c;ctx.strokeStyle=c;ctx.lineWidth=5;ctx.strokeRect(-sz/2,-sz/2,sz,sz);ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(-sz/2+4,-sz/2+4,sz-8,sz-8);ctx.fillStyle=c;ctx.font=`bold ${sz*0.5}px Arial`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(s,0,0);ctx.restore()}col(){this.dead=true;if(this.tp==='weapon'){const avail=[0,1,2,3,4].filter(i=>i!==GS.wi);if(avail.length>0){GS.wi=avail[rndI(0,avail.length-1)];msg(`NEW WEAPON!\n${CFG.WPNS[GS.wi].n}`,CFG.WPNS[GS.wi].c)}else{GS.wi=rndI(0,4);msg(`WEAPON CHANGE!\n${CFG.WPNS[GS.wi].n}`,CFG.WPNS[GS.wi].c)}}else if(this.tp==='power'){GS.wpwr=Math.min(5,GS.wpwr+1);msg(`WEAPON POWER +1\nLVL ${GS.wpwr}`,'#f60')}else if(this.tp==='health'){GS.hp=Math.min(CFG.MAX_HEALTH,GS.hp+30);msg('HEALTH +30','#0f0')}else if(this.tp==='shield'){GS.shld=true;GS.shldT=500;msg('SHIELD ACTIVE!','#0ff')}else if(this.tp==='double'){GS.dbl=true;GS.dblT=600;msg('DOUBLE POINTS!','#ff0')}else{let bs=0;enm.forEach(e=>{bs+=e.pts;exp(e.x,e.y,e.c,15)});obs.forEach(o=>{bs+=200;exp(o.x,o.y,o.c,15)});GS.sc+=bs;enm=[];obs=[];GS.shake=25;msg('MEGA BOMB!','#f05')}GS.sc+=100;playSound('powerup')}}

function spEnm(){const ln=rndI(0,CFG.LANES-1),x=getLn(ln);let ti=0;const r=Math.random();if(GS.tier>=6){if(r<0.25)ti=rndI(0,2);else if(r<0.5)ti=rndI(3,5);else if(r<0.75)ti=rndI(6,7);else if(r<0.92)ti=rndI(8,10);else ti=11}else if(GS.tier>=5){if(r<0.3)ti=rndI(0,2);else if(r<0.6)ti=rndI(3,5);else if(r<0.85)ti=rndI(6,7);else if(r<0.95)ti=rndI(8,10);else ti=11}else if(GS.tier>=4){if(r<0.35)ti=rndI(0,2);else if(r<0.7)ti=rndI(3,5);else if(r<0.92)ti=rndI(6,8);else ti=rndI(9,10)}else if(GS.tier>=3){if(r<0.4)ti=rndI(0,2);else if(r<0.75)ti=rndI(3,5);else ti=rndI(6,8)}else if(GS.tier>=2){if(r<0.5)ti=rndI(0,2);else if(r<0.88)ti=rndI(3,5);else ti=rndI(6,7)}else if(GS.tier>=1){if(r<0.6)ti=rndI(0,2);else ti=rndI(3,5)}else{if(r<0.75)ti=rndI(0,2);else ti=rndI(3,4)}enm.push(new Enemy(x,-80,ti))}

function spObs(){const ln=rndI(0,CFG.LANES-1),x=getLn(ln);obs.push(new Obs(x,-80))}
function spCoin(){const ln=rndI(0,CFG.LANES-1),x=getLn(ln);coin.push(new Coin(x,-50))}
function spPwr(){const ln=rndI(0,CFG.LANES-1),x=getLn(ln);const tps=['weapon','power','health','shield','double','bomb'],wts=[0.3,0.2,0.2,0.15,0.1,0.05];let r=Math.random(),tp=tps[0];for(let i=0;i<tps.length;i++){if(r<wts[i]){tp=tps[i];break}r-=wts[i]}pwr.push(new Pwr(x,-60,tp))}
function spTrap(){const ln=rndI(0,CFG.LANES-1),tp=Math.random()>0.6?'block':'spikes';trap.push(new Trap(ln,tp))}

function fire(){const now=Date.now(),w=CFG.WPNS[GS.wi];if(now-GS.lft<w.r)return;GS.lft=now;const px=GS.px,py=GS.py,dmg=w.d+GS.wpwr*0.5;playSound('shoot');if(w.p==='single'){bul.push(new Bullet(px,py-35,0,-CFG.BSPD,GS.wi,GS.wpwr))}else if(w.p==='triple'){bul.push(new Bullet(px,py-35,0,-CFG.BSPD,GS.wi,GS.wpwr));bul.push(new Bullet(px-20,py-28,-1,-CFG.BSPD,GS.wi,GS.wpwr));bul.push(new Bullet(px+20,py-28,1,-CFG.BSPD,GS.wi,GS.wpwr))}else if(w.p==='spread'){bul.push(new Bullet(px,py-35,0,-CFG.BSPD,GS.wi,GS.wpwr));bul.push(new Bullet(px-15,py-30,-2,-CFG.BSPD,GS.wi,GS.wpwr));bul.push(new Bullet(px+15,py-30,2,-CFG.BSPD,GS.wi,GS.wpwr));bul.push(new Bullet(px-25,py-25,-4,-CFG.BSPD*0.9,GS.wi,GS.wpwr));bul.push(new Bullet(px+25,py-25,4,-CFG.BSPD*0.9,GS.wi,GS.wpwr))}else if(w.p==='laser'){bul.push(new Bullet(px-8,py-35,0,-CFG.BSPD*1.3,GS.wi,GS.wpwr));bul.push(new Bullet(px+8,py-35,0,-CFG.BSPD*1.3,GS.wi,GS.wpwr))}else{bul.push(new Bullet(px,py-35,0,-CFG.BSPD*1.1,GS.wi,GS.wpwr));bul.push(new Bullet(px-18,py-30,-1.5,-CFG.BSPD,GS.wi,GS.wpwr));bul.push(new Bullet(px+18,py-30,1.5,-CFG.BSPD,GS.wi,GS.wpwr))}}

function drwPlr(){const px=GS.px,py=GS.py;ctx.save();ctx.translate(px,py);const tlt=(GS.tx-px)*0.0018;ctx.rotate(tlt);if(GS.shld){const sp=Math.sin(GS.frm*0.25)*0.25+0.75;ctx.strokeStyle='#0ff';ctx.lineWidth=4;ctx.shadowBlur=25;ctx.shadowColor='#0ff';ctx.globalAlpha=sp;ctx.beginPath();ctx.arc(0,0,50,0,Math.PI*2);ctx.stroke();ctx.globalAlpha=1}const w=CFG.PLAYER_W,h=CFG.PLAYER_H;ctx.shadowBlur=30;ctx.shadowColor='#0ff';ctx.fillStyle='#015';ctx.strokeStyle='#0ff';ctx.lineWidth=4;ctx.beginPath();ctx.moveTo(-w/2.5,h/2);ctx.lineTo(-w/3,-h/2.5);ctx.lineTo(-w/4,-h/2);ctx.lineTo(w/4,-h/2);ctx.lineTo(w/3,-h/2.5);ctx.lineTo(w/2.5,h/2);ctx.closePath();ctx.fill();ctx.stroke();const g=ctx.createLinearGradient(0,-h/3,0,0);g.addColorStop(0,'rgba(0,255,255,0.4)');g.addColorStop(1,'rgba(0,100,150,0.6)');ctx.fillStyle=g;ctx.fillRect(-w/4,-h/3,w/2,h/3);ctx.fillStyle='#035';ctx.fillRect(-w/2.5,-h/4,w/8,h/1.5);ctx.fillRect(w/2.5-w/8,-h/4,w/8,h/1.5);ctx.strokeStyle='#08a';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(-w/5,-h/2);ctx.lineTo(-w/6,h/2);ctx.stroke();ctx.beginPath();ctx.moveTo(w/5,-h/2);ctx.lineTo(w/6,h/2);ctx.stroke();const eg=GS.frm%3<2?'#0ff':'#fff';ctx.fillStyle=eg;ctx.shadowBlur=20;ctx.fillRect(-w/3,h/2,w/7,18);ctx.fillRect(w/3-w/7,h/2,w/7,18);ctx.fillRect(-w/2.3,h/3,w/12,10);ctx.fillRect(w/2.3-w/12,h/3,w/12,10);const wc=CFG.WPNS[GS.wi].c;ctx.fillStyle=wc;ctx.shadowColor=wc;ctx.shadowBlur=15+GS.wpwr*3;ctx.fillRect(-w/4-2,-h/2.5,4+GS.wpwr,8+GS.wpwr);ctx.fillRect(w/4-2,-h/2.5,4+GS.wpwr,8+GS.wpwr);ctx.restore()}

function drwBg(){const th=CFG.THEMES[GS.theme],g=ctx.createLinearGradient(0,0,0,canvas.height);g.addColorStop(0,th.c[0]);g.addColorStop(0.5,th.c[1]);g.addColorStop(1,th.c[2]);ctx.fillStyle=g;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#fff';for(let i=0;i<80;i++){const x=(i*137+GS.frm*0.5)%canvas.width,y=(i*241+GS.frm*(1+i%4))%canvas.height,sz=1+(i%3),al=0.3+(Math.sin(GS.frm*0.05+i)*0.3+0.4);ctx.globalAlpha=al;ctx.fillRect(x,y,sz,sz)}ctx.globalAlpha=1;ctx.strokeStyle=th.a;ctx.globalAlpha=0.1;ctx.lineWidth=1;const gs=80,oy=(GS.frm*GS.spd*0.5)%gs;for(let y=-gs+oy;y<canvas.height;y+=gs){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}for(let x=0;x<canvas.width;x+=gs){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}ctx.globalAlpha=1}

function drwRd(){const rd=getRd(),th=CFG.THEMES[GS.theme],rg=ctx.createLinearGradient(rd.l,0,rd.r,0);rg.addColorStop(0,'rgba(10,10,30,0.7)');rg.addColorStop(0.5,'rgba(20,20,50,0.8)');rg.addColorStop(1,'rgba(10,10,30,0.7)');ctx.fillStyle=rg;ctx.fillRect(rd.l,0,rd.w,canvas.height);ctx.strokeStyle=th.a;ctx.lineWidth=4;ctx.shadowBlur=15;ctx.shadowColor=th.a;ctx.beginPath();ctx.moveTo(rd.l,0);ctx.lineTo(rd.l,canvas.height);ctx.stroke();ctx.beginPath();ctx.moveTo(rd.r,0);ctx.lineTo(rd.r,canvas.height);ctx.stroke();ctx.strokeStyle='#555';ctx.lineWidth=3;ctx.shadowBlur=5;ctx.shadowColor='#888';ctx.setLineDash([25,25]);ctx.lineDashOffset=-(GS.frm*GS.spd*0.8)%50;for(let i=1;i<CFG.LANES;i++){const x=rd.l+(rd.w/CFG.LANES)*i;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}ctx.setLineDash([]);ctx.shadowBlur=0;if(GS.spd>6){const int=Math.min(1,(GS.spd-6)/14);ctx.strokeStyle=`rgba(255,255,255,${int*0.5})`;ctx.lineWidth=2;for(let i=0;i<35;i++){const x=rd.l+rnd(0,rd.w),y=(GS.frm*GS.spd*3+i*50)%canvas.height,len=40+rnd(0,40);ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x,y+len);ctx.stroke()}}}

function updDiff(){GS.et=(Date.now()-GS.st)/1000;const tiers=DIFF_CONFIGS[GS.diff].TIERS;for(let i=tiers.length-1;i>=0;i--){if(GS.et>=tiers[i].t){if(GS.tier!==i){GS.tier=i;const t=tiers[i];GS.spd=t.spd;GS.freq=t.shoot;GS.hpMult=t.hpMult;msg(`TIER ${i+1}`,'#0ff')}break}}const ti=Math.floor(GS.et/20)%CFG.THEMES.length;if(ti!==GS.theme){GS.theme=ti;msg(CFG.THEMES[ti].n,CFG.THEMES[ti].a)}}

function upd(){if(!GS.run||GS.pause)return;GS.frm++;updDiff();const t=DIFF_CONFIGS[GS.diff].TIERS[GS.tier];GS.sc+=Math.floor(GS.spd*0.1);const ms=CFG.PLAYER_SPEED;if(GS.mvL)GS.tx-=ms;if(GS.mvR)GS.tx+=ms;const rd=getRd();GS.tx=Math.max(rd.l+25,Math.min(rd.r-25,GS.tx));GS.px+=(GS.tx-GS.px)*0.2;if(isMobile||GS.fire)fire();if(GS.shld){GS.shldT--;if(GS.shldT<=0)GS.shld=false}if(GS.dbl){GS.dblT--;if(GS.dblT<=0)GS.dbl=false}if(GS.et>=CFG.DELAY){if(GS.frm%Math.max(12,Math.floor(t.eRate))===0)spEnm();if(GS.frm%Math.max(15,Math.floor(t.cRate))===0)spCoin();if(GS.frm%Math.max(50,Math.floor(t.oRate))===0&&Math.random()>0.5)spObs();if(GS.frm%Math.max(80,Math.floor(t.tRate))===0)spTrap();if(GS.frm%CFG.PINT===0)spPwr()}bul.forEach(b=>b.update());ebul.forEach(b=>b.update());enm.forEach(e=>e.update());obs.forEach(o=>o.update());coin.forEach(c=>c.update());pwr.forEach(p=>p.update());part.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.15;p.life-=p.decay;if(p.life<=0)p.dead=true});trap.forEach(t=>t.update());bul.forEach(b=>{const bdmg=b.w.d+b.pwr*0.5;enm.forEach(e=>{if(!b.dead&&!e.dead&&colC(b.x,b.y,8,e.x,e.y,e.sz/2)){b.dead=true;e.dmg(bdmg)}});obs.forEach(o=>{if(!b.dead&&!o.dead&&colR(b.x-2,b.y,4,20,o.x-o.w/2,o.y-o.h/2,o.w,o.h)){b.dead=true;o.dmg(bdmg)}})});const phb={x:GS.px-CFG.PLAYER_W/2,y:GS.py-CFG.PLAYER_H/2,w:CFG.PLAYER_W,h:CFG.PLAYER_H};ebul.forEach(b=>{if(!b.dead&&colC(b.x,b.y,b.sz,GS.px,GS.py,20)){if(!GS.shld){GS.hp-=6;GS.shake=8;exp(b.x,b.y,'#f05',8);playSound('hit');if(GS.hp<=0)gameOver()}b.dead=true}});enm.forEach(e=>{if(!e.dead&&colC(GS.px,GS.py,22,e.x,e.y,e.sz/2)){if(!GS.shld){GS.hp-=12;GS.shake=15;exp(e.x,e.y,e.c,20);playSound('hit');if(GS.hp<=0)gameOver()}e.dead=true}});obs.forEach(o=>{if(!o.dead&&colR(phb.x,phb.y,phb.w,phb.h,o.x-o.w/2,o.y-o.h/2,o.w,o.h)){if(!GS.shld){GS.hp-=18;GS.shake=18;exp(o.x,o.y,o.c,20);playSound('hit');if(GS.hp<=0)gameOver()}o.dead=true}});trap.forEach(tr=>{if(!tr.dead){const lx=getLn(tr.ln),lw=getRd().w/CFG.LANES;if(colR(phb.x,phb.y,phb.w,phb.h,lx-lw/2,tr.y-tr.h/2,lw,tr.h)){if(!GS.shld){GS.hp-=tr.dmg;GS.shake=tr.dmg;exp(GS.px,GS.py,'#f05',15);playSound('hit');if(GS.hp<=0)gameOver()}tr.dead=true}}});coin.forEach(c=>{if(!c.dead&&colC(GS.px,GS.py,30,c.x,c.y,c.sz))c.col()});pwr.forEach(p=>{if(!p.dead&&colC(GS.px,GS.py,35,p.x,p.y,p.sz))p.col()});bul=bul.filter(b=>!b.dead);ebul=ebul.filter(b=>!b.dead);enm=enm.filter(e=>!e.dead);obs=obs.filter(o=>!o.dead);coin=coin.filter(c=>!c.dead);pwr=pwr.filter(p=>!p.dead);part=part.filter(p=>!p.dead);trap=trap.filter(t=>!t.dead);updUI()}

function drw(){ctx.save();if(GS.shake>0){ctx.translate(rnd(-GS.shake,GS.shake),rnd(-GS.shake,GS.shake));GS.shake*=0.88}drwBg();drwRd();part.forEach(p=>{ctx.globalAlpha=p.life;ctx.fillStyle=p.c;ctx.shadowBlur=12;ctx.shadowColor=p.c;ctx.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz);ctx.globalAlpha=1});trap.forEach(t=>t.draw());coin.forEach(c=>c.draw());pwr.forEach(p=>p.draw());bul.forEach(b=>b.draw());ebul.forEach(b=>b.draw());obs.forEach(o=>o.draw());enm.forEach(e=>e.draw());drwPlr();ctx.restore()}

function updUI(){document.getElementById('score').textContent=Math.floor(GS.sc).toString().padStart(6,'0');document.getElementById('coins').textContent=GS.coin;const m=Math.floor(GS.et/60),s=Math.floor(GS.et%60);document.getElementById('time').textContent=`${m}:${s.toString().padStart(2,'0')}`;document.getElementById('health').textContent=`${Math.max(0,GS.hp)}%`;document.getElementById('weaponType').textContent=CFG.WPNS[GS.wi].n;document.getElementById('weaponPower').textContent=GS.wpwr>0?`+${GS.wpwr}`:'';const hel=document.getElementById('health');if(GS.hp>60){hel.style.color='#0f0';hel.style.textShadow='0 0 12px #0f0'}else if(GS.hp>30){hel.style.color='#ff0';hel.style.textShadow='0 0 12px #ff0'}else{hel.style.color='#f00';hel.style.textShadow='0 0 12px #f00'}const wel=document.getElementById('weaponType'),wc=CFG.WPNS[GS.wi].c;wel.style.color=wc;wel.style.textShadow=`0 0 12px ${wc}`}

function startGame(){console.log('Start',selectedDifficulty);document.getElementById('startScreen').classList.add('hidden');document.getElementById('gameOverScreen').classList.remove('show');GS={run:true,pause:false,frm:0,st:Date.now(),et:0,sc:0,coin:0,hp:CFG.MAX_HEALTH,wi:0,wpwr:0,tier:0,theme:0,spd:DIFF_CONFIGS[selectedDifficulty].TIERS[0].spd,freq:DIFF_CONFIGS[selectedDifficulty].TIERS[0].shoot,hpMult:DIFF_CONFIGS[selectedDifficulty].TIERS[0].hpMult,px:canvas.width/2,py:canvas.height-110,tx:canvas.width/2,shake:0,shld:false,shldT:0,dbl:false,dblT:0,fire:isMobile,lft:0,mvL:false,mvR:false,diff:selectedDifficulty};bul=[];ebul=[];enm=[];obs=[];coin=[];pwr=[];part=[];trap=[];updUI();playNextMusic()}

function togPause(){if(!GS.run)return;GS.pause=!GS.pause;const pb=document.getElementById('pauseBtn');if(GS.pause){pb.textContent='‚ñ∂';pb.classList.add('active');msg('PAUSED','#0ff');stopAllMusic()}else{pb.textContent='‚è∏';pb.classList.remove('active');GS.st=Date.now()-GS.et*1000;playNextMusic()}}

function togMute(){soundEnabled=!soundEnabled;const mb=document.getElementById('muteBtn');if(!soundEnabled){mb.textContent='üîá';mb.classList.add('active');stopAllMusic()}else{mb.textContent='üîä';mb.classList.remove('active');if(GS.run&&!GS.pause)playNextMusic()}}

function gameOver(){GS.run=false;GS.shake=35;stopAllMusic();playSound('explosion');const fsc=Math.floor(GS.sc),fcn=GS.coin,cbn=fcn*CFG.COINB,tot=fsc+cbn,m=Math.floor(GS.et/60),s=Math.floor(GS.et%60),tstr=`${m}:${s.toString().padStart(2,'0')}`;document.getElementById('finalScore').textContent=tot.toLocaleString();document.getElementById('finalCoins').textContent=fcn;document.getElementById('coinBonus').textContent=`+${cbn.toLocaleString()}`;document.getElementById('finalTime').textContent=tstr;document.getElementById('finalDiff').textContent=DIFF_CONFIGS[GS.diff].name;saveHighScore(tot,fcn,tstr,GS.diff);displayHighScores(tot,GS.diff);setTimeout(()=>document.getElementById('gameOverScreen').classList.add('show'),1000)}

window.addEventListener('keydown',e=>{if(e.key==='ArrowLeft'||e.key==='a')GS.mvL=true;if(e.key==='ArrowRight'||e.key==='d')GS.mvR=true;if(e.key===' '||e.key==='Enter'){GS.fire=true;e.preventDefault()}if(e.key==='p'||e.key==='Escape'){togPause();e.preventDefault()}if(e.key==='m')togMute()});
window.addEventListener('keyup',e=>{if(e.key==='ArrowLeft'||e.key==='a')GS.mvL=false;if(e.key==='ArrowRight'||e.key==='d')GS.mvR=false;if(e.key===' '||e.key==='Enter')GS.fire=false});
canvas.addEventListener('mousemove',e=>{if(!isMobile&&GS.run){const r=canvas.getBoundingClientRect();GS.tx=e.clientX-r.left}});
canvas.addEventListener('mousedown',()=>{if(!isMobile)GS.fire=true});
canvas.addEventListener('mouseup',()=>{if(!isMobile)GS.fire=false});

if(isMobile){document.getElementById('mobileControls').classList.add('active');let lti=null,rti=null;document.getElementById('btnLeft').addEventListener('touchstart',e=>{GS.mvL=true;lti=e.changedTouches[0].identifier;e.preventDefault()},{passive:false});document.getElementById('btnLeft').addEventListener('touchend',e=>{if(lti!==null){for(let t of e.changedTouches){if(t.identifier===lti){GS.mvL=false;lti=null}}}e.preventDefault()},{passive:false});document.getElementById('btnRight').addEventListener('touchstart',e=>{GS.mvR=true;rti=e.changedTouches[0].identifier;e.preventDefault()},{passive:false});document.getElementById('btnRight').addEventListener('touchend',e=>{if(rti!==null){for(let t of e.changedTouches){if(t.identifier===rti){GS.mvR=false;rti=null}}}e.preventDefault()},{passive:false})}

document.getElementById('easyBtn').addEventListener('click',()=>{selectedDifficulty='easy';document.getElementById('easyBtn').classList.add('selected');document.getElementById('hardBtn').classList.remove('selected')});
document.getElementById('hardBtn').addEventListener('click',()=>{selectedDifficulty='hard';document.getElementById('hardBtn').classList.add('selected');document.getElementById('easyBtn').classList.remove('selected')});
document.getElementById('pauseBtn').addEventListener('click',togPause);
document.getElementById('muteBtn').addEventListener('click',togMute);
document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('playAgainBtn').addEventListener('click',startGame);

function resize(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;GS.py=canvas.height-110;if(GS.px){const rd=getRd();GS.px=Math.max(rd.l+25,Math.min(rd.r-25,GS.px));GS.tx=GS.px}}
function loop(){upd();drw();requestAnimationFrame(loop)}
window.addEventListener('resize',resize);
resize();initSounds();loop();
console.log('Ready!');
</script>
</body>
</html>
